class SmartFinder{constructor(t){this.configUrl=t,this.config=null,this.state={email:null,answers:{},currentStep:"email",recommendations:[]},this.modal=null,this.content=null,this.isSubmitting=!1,this.init()}async init(){console.log("üöÄ D√©but init Smart Finder...");try{if(window.smartFinderConfig)console.log("‚úÖ Config inlin√©e trouv√©e (chargement instantan√©)"),this.config=window.smartFinderConfig;else{console.log("üì¶ Chargement config depuis URL:",this.configUrl);const t=await fetch(this.configUrl),e=t.headers.get("content-type");if(console.log("üìÑ Content-Type:",e),!t.ok)throw new Error(`Erreur HTTP ${t.status}: ${t.statusText}`);if(!e||!e.includes("application/json")){const e=await t.text();throw console.error("‚ùå Contenu re√ßu (pas JSON):",e.substring(0,200)),new Error("Le serveur n'a pas renvoy√© du JSON. URL: "+this.configUrl)}this.config=await t.json(),console.log("‚úÖ Config charg√©e depuis URL:",this.config)}console.log("üèóÔ∏è Cr√©ation modal..."),this.createModal(),console.log("üîå Attache √©v√©nements..."),this.attachEvents(),console.log("‚úÖ Smart Finder initialis√©")}catch(t){console.error("‚ùå Erreur initialisation Smart Finder:",t),alert("Erreur chargement Smart Finder: "+t.message)}}createModal(){document.body.insertAdjacentHTML("beforeend",'\n            <div id="captain-smart-finder-modal" class="smart-finder-modal" style="display: none;">\n                <div class="smart-finder-wrapper">\n                    <div class="smart-finder-header">\n                        <span class="smart-finder-title">üéØ Smart Finder (NicolasVirin.com)</span>\n                        <button class="smart-finder-close" onclick="window.smartFinder.close()">√ó</button>\n                    </div>\n                    <div class="smart-finder-content" id="smartFinderContent"></div>\n                </div>\n            </div>\n        '),this.modal=document.getElementById("captain-smart-finder-modal"),this.content=document.getElementById("smartFinderContent"),this.createEmailPopup()}createEmailPopup(){console.log("üìß Cr√©ation popup email...");document.body.insertAdjacentHTML("beforeend",'\n            <div id="captain-email-popup" class="captain-email-popup" style="display: none;">\n                <div class="popup-overlay" onclick="window.smartFinder.closeEmailPopup()"></div>\n                <div class="popup-content">\n                    <h2>üéØ Trouve ton app en 2 min</h2>\n                    <p class="popup-subtitle">100% gratuit ‚Ä¢ Essai 14j inclus</p>\n                    <form id="captainEmailForm">\n                        <input \n                            type="email" \n                            id="captainEmailInput"\n                            placeholder="ton@email.com" \n                            required \n                            autocomplete="email"\n                        >\n                        <button type="submit" class="btn-captain-primary">Commencer ‚Üí</button>\n                    </form>\n                    <p class="popup-note">‚úÖ Pas de CB ‚Ä¢ ‚úÖ Actif en 24-48h ‚Ä¢ ‚úÖ Support inclus</p>\n                </div>\n            </div>\n        '),console.log("‚úÖ Popup email cr√©√©e dans le DOM")}attachEvents(){const t=document.getElementById("captainEmailForm");t&&t.addEventListener("submit",t=>this.handleEmailSubmit(t));const e=document.querySelector(".smart-finder-close");e&&e.addEventListener("click",()=>this.close())}async handleEmailSubmit(t){if(t.preventDefault(),this.isSubmitting)return void console.log("‚ö†Ô∏è Submit d√©j√† en cours");this.isSubmitting=!0;const e=document.getElementById("captainEmailInput").value.trim();if(!e)return void(this.isSubmitting=!1);this.state.email=e,localStorage.setItem("captain_last_email",e),localStorage.setItem("captain_email_timestamp",Date.now().toString()),console.log("üíæ Email sauvegard√© dans localStorage");const n=document.querySelector("#captainEmailForm button");n.disabled=!0,n.textContent="‚è≥ Enregistrement...";try{const t=this.config.api.endpoint,s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})}),a=await s.json();a.success?(this.closeEmailPopup(),setTimeout(()=>{this.showSmartFinder(),this.startConversation()},500)):(alert("Erreur : "+(a.message||"Impossible de cr√©er votre compte")),n.disabled=!1,n.textContent="Commencer ‚Üí"),this.isSubmitting=!1}catch(t){console.error("‚ùå Erreur API:",t),alert("Erreur API : "+t.message),n.disabled=!1,n.textContent="Commencer ‚Üí",this.isSubmitting=!1}}showEmailPopup(){console.log("üìß Affichage popup email...");const t=document.getElementById("captain-email-popup");if(t&&"flex"===t.style.display)console.log("‚ö†Ô∏è Popup d√©j√† affich√©e");else if(t){t.style.display="flex",console.log("‚úÖ Popup email affich√©e");const e=document.querySelector("#captainEmailForm button");e&&(e.disabled=!1,e.textContent="Commencer ‚Üí"),this.isSubmitting=!1,setTimeout(()=>{const t=document.getElementById("captainEmailInput");if(t){const e=localStorage.getItem("captain_last_email"),n=localStorage.getItem("captain_email_timestamp");if(e&&n){Date.now()-parseInt(n)<18e5?(t.value=e,console.log("‚úÖ Email pr√©rempli depuis localStorage")):(localStorage.removeItem("captain_last_email"),localStorage.removeItem("captain_email_timestamp"),console.log("‚è∞ Email expir√© (> 30 min)"))}t.focus()}},100)}else console.error("‚ùå Popup email non trouv√©e dans le DOM"),alert("Erreur: Popup email non initialis√©e. Rechargez la page.")}closeEmailPopup(){const t=document.getElementById("captain-email-popup");t&&(t.style.display="none");const e=document.getElementById("captainEmailInput");e&&(e.value=""),this.isSubmitting=!1}showSmartFinder(){this.modal&&(this.modal.style.display="block",this.content.innerHTML='<div class="smart-finder-loading">‚è≥ Chargement...</div>')}close(){this.modal&&(this.modal.style.display="none"),this.reset(),this.isSubmitting=!1}reset(){const t=localStorage.getItem("captain_last_email"),e=localStorage.getItem("captain_email_timestamp");if(t&&e){Date.now()-parseInt(e)<18e5?(console.log("‚úÖ Email r√©cent conserv√© (< 30 min)"),this.state.email=t):(console.log("‚è∞ Email expir√© (> 30 min), reset complet"),this.state={email:null,answers:{},currentStep:"email",recommendations:[]})}else this.state={email:null,answers:{},currentStep:"email",recommendations:[]};this.state.answers={},this.state.recommendations=[],this.content&&(this.content.innerHTML="");const n=document.getElementById("captainEmailInput");n&&(n.value=""),this.prefilledApp=null,this.prefilledBundle=null,console.log("‚úÖ Smart Finder reset (garde email si < 30 min)")}async startConversation(){if(!this.config||!this.config.questions)return console.error("‚ùå Config non charg√©e"),await this.showMessage("‚ùå Erreur: Configuration non charg√©e. Rechargez la page."),void this.close();const t=this.config.questions[0];await this.delay(this.config.settings.typing_delay),await this.showMessage(this.config.settings.intro_message,"typing"),await this.delay(this.config.settings.typing_delay),await this.showMessage(t.text),await this.delay(this.config.settings.button_delay),this.showOptions(t)}async showMessage(t,e="normal"){if("typing"===e&&!1!==this.config?.settings?.typing_effect)return void await this.showMessageTyping(t);const n=`\n            <div class="smart-message bot animate-fade-in">\n                ${t}\n            </div>\n        `;this.content.insertAdjacentHTML("beforeend",n);const s=this.content.querySelector(".smart-message:last-child");requestAnimationFrame(()=>{s.classList.add("visible")}),this.scrollToBottom(),await this.delay(500)}async showMessageTyping(t){this.content.insertAdjacentHTML("beforeend",'\n            <div class="smart-message bot typing-message">\n                <span class="typing-text"></span>\n                <span class="typing-cursor">|</span>\n            </div>\n        '),this.scrollToBottom();const e=this.content.querySelector(".smart-message:last-child .typing-text"),n=this.content.querySelector(".smart-message:last-child .typing-cursor");for(let n=0;n<t.length;n++)e.textContent+=t[n],await this.delay(20),this.scrollToBottom();n.style.display="none",await this.delay(300)}showOptions(t){let e='<div class="smart-options">';t.options.forEach((t,n)=>{e+=`\n                <button \n                    class="smart-option-btn" \n                    data-value="${t.value}" \n                    data-weight="${t.weight}"\n                    style="animation-delay: ${.1*n}s"\n                    onclick="window.smartFinder.handleOptionClick('${t.value}', ${t.weight})"\n                >\n                    ${t.icon} ${t.label}\n                </button>\n            `}),e+="</div>",this.content.insertAdjacentHTML("beforeend",e),this.scrollToBottom()}handleOptionClick(t,e){this.state.answers.sector=t,this.showMessage("Super choix üîç Je scanne nos apps pour toi..."),setTimeout(()=>{this.calculateAndShowResults()},1500)}calculateRecommendations(){const t={};Object.keys(this.config.apps).forEach(e=>{const n=this.config.apps[e];let s=0;this.state.answers.sector===n.category?s+=n.min_score:"general"===this.state.answers.sector&&(s+=.5*n.min_score),n.featured&&(s+=15),n.social_proof&&(s+=5),n.has_lifetime&&(s+=5),s>=n.min_score&&(t[e]={app:n,score:s})});const e=Object.values(t).sort((t,e)=>t.app.featured&&!e.app.featured?-1:!t.app.featured&&e.app.featured?1:e.score-t.score).slice(0,this.config.settings.max_recommendations);return e.length<this.config.settings.min_recommendations&&this.config.fallback.enabled?this.getFallbackApps():e}getFallbackApps(){return this.config.fallback.apps.map(t=>({app:this.config.apps[t],score:25}))}async calculateAndShowResults(){const t=this.calculateRecommendations();this.state.recommendations=t,await this.showMessage(this.config.messages.results),await this.delay(300),t.forEach((t,e)=>{this.showAppCard(t.app,t.score,e)})}showAppCard(t,e,n){let s;if("object"==typeof t.pricing&&t.pricing.monthly){const e=t.pricing.monthly;s=t.has_lifetime&&t.pricing.lifetime?`\n                    <div class="app-pricing-flex">\n                        <span class="monthly">${e}‚Ç¨/mois</span>\n                        <span class="divider">OU</span>\n                        <span class="lifetime">${t.pricing.lifetime}‚Ç¨ lifetime</span>\n                    </div>\n                    <p style="font-size:0.85rem; color:#10b981; margin-top:0.5rem;">üí∞ √âconomie apr√®s ${Math.ceil(t.pricing.lifetime/e)} mois</p>\n                `:`<div class="app-price">${e}‚Ç¨<span>/mois</span></div>`}else s=`<div class="app-price">${t.pricing}‚Ç¨<span>/mois</span></div>`;const a=t.social_proof?`<div class="app-social-proof">${t.social_proof}</div>`:"",i=t.featured||!1;let o=[...t.badges||[]];i&&o.unshift("‚≠ê Featured");let l="";t.modules&&"object"==typeof t.modules&&(l=`\n                <div class="app-modules">\n                    <div class="modules-title">üì¶ Contenu inclus :</div>\n                    <div class="modules-list">\n                        ${Object.entries(t.modules).map(([t,e])=>`<div class="module-item"><strong>${t}</strong>: ${e}</div>`).join("")}\n                    </div>\n                </div>\n            `);const r=`\n            <div class="smart-app-card ${i?"featured":""}" style="animation-delay: ${.15*n}s">\n                ${o.length>0?`<div class="app-badges-header">${o.map(t=>`<span class="app-badge ${t.includes("Featured")?"featured-badge":""}">${t}</span>`).join("")}</div>`:""}\n                <div class="app-header">\n                    <span class="app-icon">${t.icon}</span>\n                    <div class="app-info">\n                        <h4>${t.name}</h4>\n                        <p class="app-description">${t.description}</p>\n                    </div>\n                </div>\n                ${a}\n                ${l}\n                <div class="app-match">\n                    <span class="match-badge">${e}% match</span>\n                </div>\n                <div class="app-details">\n                    ${s}\n                    <div class="app-setup">‚ö° ${t.setup_time}</div>\n                </div>\n                <button \n                    class="btn-app-select" \n                    onclick="window.smartFinder.selectApp('${t.id}')"\n                >\n                    Essayer gratuitement ‚Üí\n                </button>\n            </div>\n        `;this.content.insertAdjacentHTML("beforeend",r),this.scrollToBottom()}async selectApp(t){if(this.isSubmitting)console.log("‚ö†Ô∏è Selection d√©j√† en cours");else{this.isSubmitting=!0;try{const e=this.config.apps[t];await this.submitLeadImmediate(e),await this.showMessage(this.config.messages.email_sent),await this.delay(2e3),await this.showMessage(this.config.messages.form_intro),e.form_questions&&e.form_questions.length>0?this.showContextualForm(e):await this.showEnrichmentForm(e)}catch(t){console.error("‚ùå Erreur s√©lection app:",t),this.isSubmitting=!1}}}async submitLeadImmediate(t){const e="captain_lead_sent_"+this.state.email+"_"+t.id,n=localStorage.getItem(e);if(n){const s=parseInt(n);if(Date.now()-s<864e5){const e=Math.floor((Date.now()-s)/1e3/60);return void console.log(`‚è≠Ô∏è Lead pour ${t.id} envoy√© il y a ${e} min, skip (protection 24h)`)}console.log("‚è∞ Lead ancien (> 24h), permettre nouveau lead pour cette app"),localStorage.removeItem(e)}const s={email:this.state.email,app_interest:t.id,category:t.category};try{const n=await fetch(this.config.api.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});(await n.json()).success&&(localStorage.setItem(e,Date.now().toString()),console.log("‚úÖ Lead imm√©diat soumis pour "+t.id))}catch(t){console.error("‚ùå Erreur soumission imm√©diate:",t)}}async showEnrichmentForm(t){const e=localStorage.getItem("captain_last_firstName"),n=localStorage.getItem("captain_last_lastName"),s=localStorage.getItem("captain_last_phone"),a=localStorage.getItem("captain_enrichment_timestamp");if(a&&Date.now()-parseInt(a)<18e5&&e&&s)return console.log("‚úÖ Donn√©es r√©centes trouv√©es dans localStorage - Auto-submit"),void await this.submitEnrichment(t,{firstName:e,lastName:n||"",phone:s});if(localStorage.getItem("captain_lead_completed_"+this.state.email))return console.log("‚úÖ Lead d√©j√† compl√©t√©, fermeture directe"),await this.showMessage(this.config.messages.success),void setTimeout(()=>{this.close()},3e3);const i=`\n            <form id="enrichmentForm" class="smart-form">\n                <p style="color: #6b7280; margin-bottom: 1rem;">Ces infos me permettent de te contacter directement</p>\n                \n                <label>Pr√©nom (optionnel)</label>\n                <input \n                    type="text" \n                    name="firstName" \n                    placeholder="Jean"\n                    value="${e||""}"\n                >\n                \n                <label>Nom de famille (optionnel)</label>\n                <input \n                    type="text" \n                    name="lastName" \n                    placeholder="Dupont"\n                    value="${n||""}"\n                >\n                \n                <label>T√©l√©phone (optionnel)</label>\n                <input \n                    type="tel" \n                    name="phone" \n                    placeholder="+33 6 12 34 56 78"\n                    value="${s||""}"\n                >\n                \n                <div style="display: flex; gap: 10px; margin-top: 1rem;">\n                    <button type="submit" class="btn-captain-primary" style="flex: 1;">\n                        Envoyer ‚Üí\n                    </button>\n                    <button type="button" class="btn-captain-secondary" onclick="window.smartFinder.skipEnrichment()">\n                        Passer ‚Üí\n                    </button>\n                </div>\n            </form>\n        `;this.content.insertAdjacentHTML("beforeend",i),this.scrollToBottom(),document.getElementById("enrichmentForm").addEventListener("submit",async e=>{e.preventDefault();const n=new FormData(e.target),s={};n.forEach((t,e)=>{s[e]=t}),await this.submitEnrichment(t,s)})}async submitEnrichment(t,e){e.firstName&&localStorage.setItem("captain_last_firstName",e.firstName),e.lastName&&localStorage.setItem("captain_last_lastName",e.lastName),e.phone&&localStorage.setItem("captain_last_phone",e.phone),localStorage.setItem("captain_enrichment_timestamp",Date.now().toString());const n=localStorage.getItem("captain_last_restaurant_name")||"",s=localStorage.getItem("captain_last_restaurant_tables")||"",a=localStorage.getItem("captain_last_products_count")||"",i=t.modules?JSON.stringify(t.modules):"",o={email:this.state.email,firstName:e.firstName||"",lastName:e.lastName||"",phone:e.phone||"",app_interest:t.id,category:t.category,restaurant_name:n,restaurant_tables:s,products_count:a,modules:i};try{const t=await fetch(this.config.api.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});(await t.json()).success?(this.state.email&&localStorage.setItem("captain_lead_completed_"+this.state.email,Date.now().toString()),await this.showMessage(this.config.messages.enrichment_success)):await this.showMessage(this.config.messages.success),this.isSubmitting=!1,setTimeout(()=>{this.close()},3e3)}catch(t){console.error("Erreur enrichissement:",t),this.isSubmitting=!1,await this.showMessage(this.config.messages.success),setTimeout(()=>{this.close()},3e3)}}async skipEnrichment(){this.state.email&&localStorage.setItem("captain_lead_completed_"+this.state.email,Date.now().toString()),await this.showMessage(this.config.messages.success),setTimeout(()=>{this.close()},3e3)}showContextualForm(t){let e='<form id="contextualForm" class="smart-form">';t.form_questions.forEach(t=>{"text"===t.type?e+=`\n                    <label>${t.label}</label>\n                    <input \n                        type="text" \n                        name="${t.id}" \n                        placeholder="${t.placeholder||""}"\n                        ${t.required?"required":""}\n                    >\n                `:"select"===t.type&&(e+=`\n                    <label>${t.label}</label>\n                    <select name="${t.id}" ${t.required?"required":""}>\n                        ${t.options.map(t=>`<option value="${t}">${t}</option>`).join("")}\n                    </select>\n                `)});const n=localStorage.getItem("captain_last_firstName"),s=localStorage.getItem("captain_last_phone"),a=localStorage.getItem("captain_last_restaurant_name"),i=localStorage.getItem("captain_last_restaurant_tables"),o=localStorage.getItem("captain_last_products_count");e+='\n            <div style="display: flex; gap: 10px; margin-top: 1rem;">\n                <button type="submit" class="btn-captain-primary" style="flex: 1;">Continuer ‚Üí</button>\n                <button type="button" class="btn-captain-secondary" onclick="window.smartFinder.skipEnrichment()">\n                    Passer ‚Üí\n                </button>\n            </div>\n        </form>\n        ',this.content.insertAdjacentHTML("beforeend",e);document.querySelectorAll("#contextualForm input, #contextualForm select").forEach(t=>{const e=t.name;"firstName"===e&&n?t.value=n:"phone"===e&&s?t.value=s:"restaurant_name"===e&&a?t.value=a:"tables"===e&&i?t.value=i:"products_count"===e&&o&&(t.value=o)}),this.scrollToBottom();document.getElementById("contextualForm").addEventListener("submit",e=>{e.preventDefault(),this.handleFormSubmit(t)})}async handleFormSubmit(t){const e=document.getElementById("contextualForm"),n=new FormData(e),s={};n.forEach((t,e)=>{s[e]=t}),s.restaurant_name&&localStorage.setItem("captain_last_restaurant_name",s.restaurant_name),s.tables&&localStorage.setItem("captain_last_restaurant_tables",s.tables),s.products_count&&localStorage.setItem("captain_last_products_count",s.products_count),await this.showEnrichmentForm(t)}async submitForm(t,e){if(this.isSubmitting)return void console.log("‚ö†Ô∏è Submit d√©j√† en cours");this.isSubmitting=!0;const n=document.getElementById("contextualForm");n&&(n.querySelector("button").disabled=!0);try{const n={restaurant_name:e.restaurant_name||"",tables:e.tables||"",products_count:e.products_count||""},s=t.modules?JSON.stringify(t.modules):"",a={email:this.state.email,firstName:"",lastName:"",company:"",phone:"",app_interest:t.id,category:t.category,restaurant_name:n.restaurant_name,restaurant_tables:n.tables,products_count:n.products_count,modules:s,message:JSON.stringify(e)};console.log("üì§ SMART FINDER ‚Üí PLUGIN (submitEnrichment)"),console.log("üì¶ Donn√©es compl√®tes envoy√©es:",a),console.log("üîó Endpoint:",this.config.api.endpoint);const i=await fetch(this.config.api.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),o=await i.json();console.log("üì• PLUGIN ‚Üí SMART FINDER"),console.log("‚úÖ R√©ponse re√ßue:",o),o.success?(localStorage.removeItem("captain_last_email"),localStorage.removeItem("captain_email_timestamp"),console.log("üóëÔ∏è Email effac√© de localStorage (soumission r√©ussie)"),await this.showMessage(this.config.messages.success),setTimeout(()=>{this.close()},3e3),this.isSubmitting=!1):(await this.showMessage("‚ùå Erreur : "+(o.message||"Impossible de finaliser")),this.isSubmitting=!1)}catch(t){console.error("‚ùå Erreur soumission:",t),await this.showMessage("‚ùå Erreur r√©seau. R√©essayez plus tard."),this.isSubmitting=!1}}scrollToBottom(){this.content&&(this.content.scrollTop=this.content.scrollHeight)}delay(t){return new Promise(e=>setTimeout(e,t))}}let smartFinder=null;document.addEventListener("DOMContentLoaded",()=>{console.log("üéØ Initialisation Smart Finder...");try{window.smartFinder=new SmartFinder("smart-finder-config.json"),setTimeout(()=>{const t=document.querySelectorAll("[data-smart-finder]");console.log("üìå CTAs trouv√©s:",t.length),t.forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),console.log("üëÜ Clic sur CTA Smart Finder");const n=t.getAttribute("data-app"),s=t.getAttribute("data-bundle"),a=t.getAttribute("data-action");window.smartFinder?("demo"===a&&n&&console.log("üéØ Mode d√©mo pour app:",n),window.smartFinder.prefilledApp=n,window.smartFinder.prefilledBundle=s,window.smartFinder.showEmailPopup()):(console.error("‚ùå SmartFinder not initialized"),alert("Smart Finder non initialis√©. V√©rifiez la console pour les erreurs."))})})},1e3)}catch(t){console.error("‚ùå Erreur initialisation Smart Finder:",t)}}),window.SmartFinder=SmartFinder;